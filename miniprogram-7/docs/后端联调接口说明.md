# Research Pilot 后端联调接口说明（2026-02-18）

## 1. 已部署地址
- Base URL: `http://111.229.204.242:8081`

## 2. 已可用接口
- `GET /healthz`：健康检查
- `POST /auth/wx-login`：微信登录，返回 JWT
- `POST /auth/email-register`：邮箱注册（注册成功即返回 JWT）
- `POST /auth/email-login`：邮箱密码登录（账号或密码错误返回 401）
- `GET /users/me`：当前用户信息（需 Bearer Token）
- `PUT /users/me/profile`：更新昵称/头像（需 Bearer Token）
- `GET /papers/feed`：论文流（需 Bearer Token）
- `GET /papers/:id`：论文详情（标题/摘要/作者/链接，需 Bearer Token）
- `POST /papers/:id/action`：论文动作 `PASS|MARK|READ`（需 Bearer Token）
- `GET /profile/dashboard`：个人统计（需 Bearer Token）
- `POST /lab/review-simulator`：同步审稿（兼容接口，适合小文本）
- `POST /lab/review-simulator/tasks`：创建异步审稿任务（推荐）
- `GET /lab/review-simulator/tasks/:taskId`：查询异步审稿任务状态（推荐）

## 3. 鉴权方式
- 请求头：`Authorization: Bearer <token>`
- `token` 来源：`POST /auth/wx-login` 成功返回的 `token`
  或 `POST /auth/email-register` 成功返回的 `token`

## 3.1 邮箱注册示例
```bash
curl -X POST "http://111.229.204.242:8081/auth/email-register" \
  -H "Content-Type: application/json" \
  -d '{
    "email":"alice@example.com",
    "password":"Passw0rd!123",
    "fullName":"Alice",
    "fieldOfStudy":"NLP"
  }'
```

## 3.2 邮箱登录示例
```bash
curl -X POST "http://111.229.204.242:8081/auth/email-login" \
  -H "Content-Type: application/json" \
  -d '{
    "email":"alice@example.com",
    "password":"Passw0rd!123"
  }'
```

## 4. Feed 查询参数
- `page`：页码，默认 `1`
- `pageSize`：每页条数，默认 `10`，最大 `30`
- `keywords`：检索关键词，留空则使用后端默认关键词（`DEFAULT_FEED_KEYWORDS`）

示例：
```bash
curl -H "Authorization: Bearer <token>" \
  "http://111.229.204.242:8081/papers/feed?page=1&pageSize=10&keywords=large%20language%20model"
```

说明：
- `/papers/feed` 优先调用 Semantic Scholar API（`/graph/v1/paper/search`）
- 如 Semantic Scholar 出现限流或临时错误，会自动回退本地缓存数据，响应中 `meta.source=local_cache`
- 建议在部署环境配置 `SEMANTIC_SCHOLAR_API_KEY`，减少 429 频率

## 5. 论文动作示例
```bash
curl -X POST "http://111.229.204.242:8081/papers/2cc95a16-4d2e-4d7d-bfda-98dfa7a2a001/action" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"action":"MARK"}'
```

## 6. 演示数据
- 已注入 3 篇演示论文和对应摘要，SQL 文件：
  - `backend/scripts/seed_demo.sql`

如需重新注入：
```bash
docker exec -i rp-postgres psql -U rp_user -d research_pilot < /opt/research-pilot/backend/scripts/seed_demo.sql
```

## 7. 新增环境变量
- `SEMANTIC_SCHOLAR_API_KEY`：Semantic Scholar 官方 API Key
- `DEFAULT_FEED_KEYWORDS`：默认推荐检索词（用户输入留空时使用）
- `LLM_API_KEY`：AI 审稿模型 API Key
- `LLM_BASE_URL`：模型服务 base URL（示例 `https://api-inference.modelscope.cn`）
- `REVIEW_MODEL_NAME`：审稿模型名（默认 `deepseek-ai/DeepSeek-V3.2`）

## 8. Review Simulator（推荐：异步任务）

### 8.1 创建任务
```bash
curl -X POST "http://111.229.204.242:8081/lab/review-simulator/tasks" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "draft.pdf",
    "mimeType": "application/pdf",
    "extension": "pdf",
    "fileUrl": "https://<cloud-temp-url>"
  }'
```

返回示例：
```json
{
  "task": {
    "taskId": "uuid",
    "status": "PENDING"
  }
}
```

### 8.2 查询任务
```bash
curl -H "Authorization: Bearer <token>" \
  "http://111.229.204.242:8081/lab/review-simulator/tasks/<taskId>"
```

状态说明：
- `PENDING`：任务已创建
- `RUNNING`：正在审稿
- `DONE`：审稿完成，可取 `review`
- `FAILED`：审稿失败，可看 `error`

### 8.3 同步接口说明
- `POST /lab/review-simulator` 仍可用，但 AnyService 场景下大文件/长处理更容易超时。
- 小程序当前已默认切到异步任务模式，规避 `cloud.callContainer 102002` 超时问题。
